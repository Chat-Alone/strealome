<!DOCTYPE html>
<html lang="zh-CN" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Alone - 直播平台</title>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'space-mono': ['Space Mono', 'monospace']
                    },
                    colors: {
                        'dark-card': '#0A0A0A',
                        'dark-card-hover': '#1A1A1A',
                    }
                }
            }
        }
    </script>

    <style>
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .dark body {
            background-color: #000000;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #404040;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #606060;
        }

        .pagination-button {
            min-width: 2.5rem;
        }
    </style>
</head>

<body class="h-full bg-gray-50 dark:bg-black text-gray-900 dark:text-white font-inter">
    <nav
        class="bg-white dark:bg-black shadow-sm dark:shadow-gray-800 sticky top-0 z-50 border-b border-gray-200 dark:border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                        <span class="hidden sm:inline">Stream Alone</span>
                        <span class="inline sm:hidden">SA</span>
                    </h1>
                </div>

                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" aria-label="Toggle theme"
                        class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                        <i class="fas fa-moon text-blue-400 hidden dark:inline"></i>
                    </button>

                    <div class="flex items-center space-x-3 text-sm">
                        <div id="current-user-display"
                            class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full">
                            <i class="fas fa-user mr-1"></i>
                            <span class="font-medium">Loading...</span>
                        </div>
                        <button id="logout-btn"
                            class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-medium">
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            登出
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <section class="mb-12" aria-labelledby="all-rooms-heading">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div class="flex items-center gap-4 mb-4 sm:mb-0">
                    <h2 id="all-rooms-heading" class="text-2xl font-bold text-gray-900 dark:text-white">
                        房间列表
                    </h2>
                    <button id="join-room-btn"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors text-sm">
                        <i class="fas fa-users mr-2"></i>
                        加入房间
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search-rooms" placeholder="搜索房间名或创建者..."
                            aria-label="Search rooms by name or creator"
                            class="pl-10 pr-4 py-2 w-full sm:w-64 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-[#0A0A0A] text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="relative">
                        <select id="filter-status" aria-label="Filter rooms by status"
                            class="appearance-none pl-4 pr-10 py-2 w-full sm:w-auto border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-[#0A0A0A] text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">所有状态</option>
                            <option value="live">直播中</option>
                            <option value="offline">离线</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700 dark:text-gray-300">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6" id="rooms-grid">
                <p class="col-span-full text-center text-gray-500 dark:text-gray-400 py-8">正在加载房间列表...</p>
            </div>

            <div id="all-rooms-pagination-controls" class="flex justify-center items-center space-x-2 mt-6">
            </div>
        </section>

        <section aria-labelledby="my-rooms-heading">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <h2 id="my-rooms-heading" class="text-2xl font-bold text-gray-900 dark:text-white mb-4 sm:mb-0">
                    我创建的房间
                </h2>

                <button id="create-room-btn"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    创建新房间
                </button>
            </div>

            <div
                class="bg-white dark:bg-[#0A0A0A] rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-[#1A1A1A]">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    房间名</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    创建时间</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    状态</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                    操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-[#0A0A0A] divide-y divide-gray-200 dark:divide-gray-700"
                            id="my-rooms-tbody">
                            <tr>
                                <td colspan="4" class="text-center py-12 text-gray-500 dark:text-gray-400">正在加载我创建的房间...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="empty-state" class="hidden text-center py-12">
                    <i class="fas fa-home text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400 mb-4">您还没有创建任何房间</p>
                    <button
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors create-room-trigger">
                        <i class="fas fa-plus mr-2"></i>
                        创建第一个房间
                    </button>
                </div>
            </div>

            <div id="my-rooms-pagination-controls" class="flex justify-center items-center space-x-2 mt-6">
            </div>
        </section>
    </main>

    <div id="create-room-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" role="dialog"
        aria-modal="true" aria-labelledby="create-room-modal-title">
        <div class="bg-white dark:bg-[#0A0A0A] rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="create-room-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">创建新房间
                    </h3>
                    <button id="close-modal" aria-label="Close create room modal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label for="room-name-input"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">房间名称</label>
                    <input type="text" id="room-name-input" placeholder="请输入房间名称..."
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-[#0A0A0A] text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="flex space-x-3">
                    <button id="confirm-create-room"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                        创建房间
                    </button>
                    <button id="cancel-create-room"
                        class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-medium transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="join-room-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" role="dialog"
        aria-modal="true" aria-labelledby="join-room-modal-title">
        <div class="bg-white dark:bg-[#0A0A0A] rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="join-room-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-users mr-2 text-green-600"></i>
                        加入房间
                    </h3>
                    <button id="close-join-modal" aria-label="Close join room modal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label for="share-code-input"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">分享代码</label>
                    <input type="text" id="share-code-input" placeholder="请输入房间分享代码..."
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-[#0A0A0A] text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        输入主播分享给您的房间代码
                    </p>
                </div>

                <div class="flex space-x-3">
                    <button id="confirm-join-room"
                        class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        加入房间
                    </button>
                    <button id="cancel-join-room"
                        class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-medium transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="transfer-host-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" role="dialog"
        aria-modal="true" aria-labelledby="transfer-host-modal-title">
        <div class="bg-white dark:bg-[#0A0A0A] rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="transfer-host-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">
                        转移房间所有权</h3>
                    <button id="close-transfer-modal" aria-label="Close transfer host modal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p id="transfer-room-name-info" class="text-sm text-gray-700 dark:text-gray-300 mb-4"></p>
                <div class="mb-4">
                    <label for="new-host-name-input"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">新主持人用户名</label>
                    <input type="text" id="new-host-name-input" placeholder="请输入新主持人的用户名..."
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-[#0A0A0A] text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div class="flex space-x-3">
                    <button id="confirm-transfer-host"
                        class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors">
                        确认转移
                    </button>
                    <button id="cancel-transfer-host"
                        class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-medium transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        const AppState = {
            theme: localStorage.getItem('theme') || 'light',
            currentUser: { internalId: null, name: 'Loading...' },
            allRooms: [],
            myRooms: [],
            allRoomsCurrentPage: 1,
            allRoomsItemsPerPage: 8,
            myRoomsCurrentPage: 1,
            myRoomsItemsPerPage: 5,
        };

        async function fetchAPI(endpoint, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };
            const config = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers,
                },
            };

            try {
                const response = await fetch(endpoint, config);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errData = await response.json();
                        errorMsg = errData.message || errData.error || JSON.stringify(errData) || errorMsg;
                    } catch (e) { /* ignore json parsing error */ }
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'API request failed');
                }
                return data.payload;
            } catch (error) {
                console.error('API Fetch Error:', error);
                window.roomManager?.showNotification(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        function formatISODate(isoString) {
            if (!isoString) return 'N/A';
            try {
                return new Date(isoString).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', hour12: true
                }).replace(/\//g, '-');
            } catch (e) {
                return 'Invalid Date';
            }
        }


        class ThemeManager {
            constructor() {
                this.init();
            }

            async init() {
                this.applyTheme(AppState.theme);
                this.bindEvents();
                await this.fetchUserProfile();
            }

            applyTheme(theme) {
                const html = document.documentElement;
                if (theme === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
                AppState.theme = theme;
                localStorage.setItem('theme', theme);
            }

            toggleTheme() {
                const newTheme = AppState.theme === 'light' ? 'dark' : 'light';
                this.applyTheme(newTheme);
            }

            async fetchUserProfile() {
                try {
                    //TODO: The JWT `sub` is i32, but not used here for profile fetch.
                    const userData = await fetchAPI('/user/profile');
                    AppState.currentUser.name = userData.username;
                    // Assuming user ID might be needed later, but API doesn't return it in /user/profile
                    // AppState.currentUser.internalId = userData.id; // If API returned it
                    const userDisplay = document.getElementById('current-user-display')?.querySelector('span');
                    if (userDisplay) userDisplay.textContent = AppState.currentUser.name;
                } catch (error) {
                    const userDisplay = document.getElementById('current-user-display')?.querySelector('span');
                    if (userDisplay) userDisplay.textContent = "Error";
                    window.roomManager?.showNotification('无法加载用户信息', 'error');
                }
            }


            bindEvents() {
                const themeToggleBtn = document.getElementById('theme-toggle');
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', () => {
                        this.toggleTheme();
                    });
                }
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await fetchAPI('/user/logout', { method: 'POST' });
                            window.roomManager?.showNotification('已成功登出', 'success');
                            window.location.href = '/login';
                        } catch (error) {
                            // Notification is handled by fetchAPI
                        }
                    });
                }
            }
        }

        class RoomManager {
            constructor() {
                this.roomIdToTransfer = null;
                this.roomNameToTransfer = null;
                this.init();
            }

            async init() {
                await this.fetchRoomsData();
                this.bindEvents();
                this.bindTransferHostModalEvents();
            }

            async fetchRoomsData() {
                await this.fetchMyRooms();
                await this.fetchPublicRooms(); // This will populate allRooms
                this.renderAllRooms(); // Render all rooms after fetching public rooms
                this.renderMyRooms();  // Render my rooms after fetching my rooms
            }

            async fetchMyRooms() {
                try {
                    const data = await fetchAPI('/room/my');
                    AppState.myRooms = data.related_rooms.map(room => ({
                        id: room.share_link,
                        name: room.name,
                        createTime: formatISODate(room.created_at),
                        status: 'offline', // API doesn't provide status for related_rooms
                        ownerName: AppState.currentUser.name // These are user's related rooms
                    }));
                } catch (error) {
                    AppState.myRooms = [];
                    this.showNotification('无法加载我创建的房间', 'error');
                }
                this.renderMyRooms();
            }

            async fetchPublicRooms() {
                //TODO: API endpoint for all public rooms is not defined in the spec.
                // Using related_rooms as a placeholder for allRooms data for now, this should be a separate API call.
                // For proper functionality, this API should return: id (share_link), name, creator, createTime, status, audienceCount.
                this.showNotification('加载房间列表功能(fetchPublicRooms)的API端点未定义，将使用模拟数据或空列表。', 'info');
                try {
                    // Placeholder: Simulating fetching "all" rooms.
                    // In a real scenario, this would be a different endpoint like GET /chat/room/all
                    // and its response structure might differ (e.g. include 'creator', 'status', 'audienceCount').
                    const data = await fetchAPI('/room/my'); // Re-using related_rooms for demo
                    AppState.allRooms = data.related_rooms.map(apiRoom => ({
                        id: apiRoom.share_link,
                        name: apiRoom.name,
                        creator: AppState.currentUser.name, // Placeholder, API should provide actual creator
                        createTime: formatISODate(apiRoom.created_at),
                        status: 'offline', // Placeholder, API should provide status
                        audienceCount: Math.floor(Math.random() * 50) // Placeholder, API should provide audience
                    }));
                } catch (error) {
                    AppState.allRooms = [
                        //TODO: Remove this placeholder test data for allRooms if a real public API is implemented
                        { id: 'public-room-1', name: '公共游戏时光', creator: '主播张三', createTime: '2024-06-01 10:00 AM', status: 'live', audienceCount: 15 },
                        { id: 'public-room-2', name: '公共音乐分享', creator: '音乐达人李四', createTime: '2024-06-01 09:30 AM', status: 'live', audienceCount: 25 },
                        { id: 'public-room-3', name: '公共技术讨论', creator: '程序员王五', createTime: '2024-05-30 08:00 PM', status: 'offline', audienceCount: 0 },
                    ];
                    this.showNotification('无法加载公共房间列表，使用占位数据。', 'error');
                }
                this.renderAllRooms();
            }


            renderAllRooms() {
                const grid = document.getElementById('rooms-grid');
                if (!grid) return;

                const searchInput = document.getElementById('search-rooms');
                const statusFilterSelect = document.getElementById('filter-status');

                const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : "";
                const statusFilter = statusFilterSelect ? statusFilterSelect.value : "all";

                let filteredRooms = AppState.allRooms.filter(room => {
                    const matchesSearch = room.name.toLowerCase().includes(searchTerm) ||
                        (room.creator && room.creator.toLowerCase().includes(searchTerm));
                    const matchesStatus = statusFilter === 'all' || room.status === statusFilter;
                    return matchesSearch && matchesStatus;
                });

                const startIndex = (AppState.allRoomsCurrentPage - 1) * AppState.allRoomsItemsPerPage;
                const endIndex = startIndex + AppState.allRoomsItemsPerPage;
                const paginatedRooms = filteredRooms.slice(startIndex, endIndex);

                if (paginatedRooms.length === 0 && filteredRooms.length > 0 && AppState.allRoomsCurrentPage > 1) {
                    AppState.allRoomsCurrentPage = Math.ceil(filteredRooms.length / AppState.allRoomsItemsPerPage);
                    this.renderAllRooms(); // Re-render with corrected page
                    return;
                }

                if (paginatedRooms.length > 0) {
                    grid.innerHTML = paginatedRooms.map(room => this.createRoomCard(room)).join('');
                } else if (AppState.allRooms.length === 0 && searchTerm === "" && statusFilter === "all") {
                    grid.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400 py-8">暂无直播房间。</p>`;
                }
                else {
                    grid.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400 py-8">没有找到符合条件的房间。</p>`;
                }

                this.renderAllRoomsPagination(filteredRooms.length);
            }

            renderAllRoomsPagination(totalItems) {
                const container = document.getElementById('all-rooms-pagination-controls');
                if (!container) return;

                const currentPage = AppState.allRoomsCurrentPage;
                const itemsPerPage = AppState.allRoomsItemsPerPage;
                const totalPages = Math.ceil(totalItems / itemsPerPage);

                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let paginationHTML = '';
                paginationHTML += `
                    <button
                        onclick="window.roomManager.changeAllRoomsPage(${currentPage - 1})"
                        class="pagination-button px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage === 1 ? 'disabled' : ''}
                        aria-label="Previous page"
                    >
                        <i class="fas fa-chevron-left mr-1 sm:mr-2"></i>
                        <span class="hidden sm:inline">上一页</span>
                    </button>
                `;

                for (let i = 1; i <= totalPages; i++) {
                    if (i === currentPage) {
                        paginationHTML += `<span class="pagination-button px-4 py-2 bg-blue-600 text-white rounded-lg font-medium" aria-current="page">${i}</span>`;
                    } else {
                        paginationHTML += `
                            <button
                                onclick="window.roomManager.changeAllRoomsPage(${i})"
                                class="pagination-button px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                aria-label="Go to page ${i}"
                            >
                                ${i}
                            </button>
                        `;
                    }
                }

                paginationHTML += `
                    <button
                        onclick="window.roomManager.changeAllRoomsPage(${currentPage + 1})"
                        class="pagination-button px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage === totalPages ? 'disabled' : ''}
                        aria-label="Next page"
                    >
                        <span class="hidden sm:inline">下一页</span>
                        <i class="fas fa-chevron-right ml-1 sm:ml-2"></i>
                    </button>
                `;
                container.innerHTML = paginationHTML;
            }

            changeAllRoomsPage(newPage) {
                AppState.allRoomsCurrentPage = newPage;
                this.renderAllRooms();
            }

            createRoomCard(room) {
                const statusBadge = room.status === 'live'
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"><span class="w-2 h-2 bg-red-400 rounded-full mr-1 animate-pulse"></span>直播中</span>'
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">离线</span>';

                let coverDisplayHTML;
                if (room.status === 'live') {
                    const liveCoverImageSrc = 'https://placehold.co/300x200/E5E7EB/6B7280?text=300x200';
                    coverDisplayHTML = `<img src="${liveCoverImageSrc}" alt="${room.name}" class="w-full h-full object-cover">`;
                } else {
                    coverDisplayHTML = `
                        <div class="w-full h-full flex items-center justify-center bg-gray-200 dark:bg-gray-800">
                            <i class="fas fa-video-slash text-gray-500 dark:text-gray-400 text-5xl"></i>
                        </div>
                    `;
                }

                const audienceDisplay = room.status === 'live' && typeof room.audienceCount === 'number'
                    ? `<span class="text-xs text-gray-500 dark:text-gray-400"><i class="fas fa-eye mr-1"></i>${room.audienceCount}</span>`
                    : '';

                return `
                    <div class="bg-white dark:bg-dark-card rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md dark:hover:bg-dark-card-hover transition-shadow">
                        <div class="aspect-video relative overflow-hidden">
                            ${coverDisplayHTML}
                            ${room.status === 'live' ? '<div class="absolute top-2 left-2"><span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-medium">LIVE</span></div>' : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-gray-900 dark:text-white mb-2 truncate" title="${room.name}">${room.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                                <i class="fas fa-user-tie mr-1"></i>
                                ${room.creator || 'N/A'}
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-500 mb-3">
                                <i class="fas fa-clock mr-1"></i>
                                ${room.createTime}
                            </p>
                            <div class="flex justify-between items-center">
                                ${statusBadge}
                                ${audienceDisplay}
                            </div>
                             ${room.status === 'live' ? `<button onclick="window.roomManager.joinLiveRoom('${room.id}')" class="mt-3 w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors">进入房间</button>` : ''}
                        </div>
                    </div>
                `;
            }

            joinLiveRoom(roomId) {
                //TODO: Implement actual room joining logic (e.g., redirect or open video player using share_link/roomId)
                this.showNotification(`尝试进入房间 ${roomId}... (功能待实现)`, 'info');
                // window.location.href = `/${roomId}`; // This would use the share_link as path
            }


            renderMyRooms() {
                const tbody = document.getElementById('my-rooms-tbody');
                const emptyState = document.getElementById('empty-state');

                if (!tbody || !emptyState) return;

                const currentUserRooms = AppState.myRooms.filter(room => room.ownerName === AppState.currentUser.name);


                if (currentUserRooms.length === 0) {
                    tbody.innerHTML = ''; // Clear previous loading message
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    const startIndex = (AppState.myRoomsCurrentPage - 1) * AppState.myRoomsItemsPerPage;
                    const endIndex = startIndex + AppState.myRoomsItemsPerPage;
                    const paginatedMyRooms = currentUserRooms.slice(startIndex, endIndex);
                    tbody.innerHTML = paginatedMyRooms.map(room => this.createMyRoomRow(room)).join('');
                }
                this.renderMyRoomsPagination(currentUserRooms.length);
            }

            renderMyRoomsPagination(totalItems) {
                const container = document.getElementById('my-rooms-pagination-controls');
                if (!container) return;

                const currentPage = AppState.myRoomsCurrentPage;
                const itemsPerPage = AppState.myRoomsItemsPerPage;
                const totalPages = Math.ceil(totalItems / itemsPerPage);

                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                let paginationHTML = '';
                paginationHTML += `
                    <button
                        onclick="window.roomManager.changeMyRoomsPage(${currentPage - 1})"
                        class="pagination-button px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage === 1 ? 'disabled' : ''}
                        aria-label="Previous page for my rooms"
                    >
                        <i class="fas fa-chevron-left mr-1 sm:mr-2"></i>
                        <span class="hidden sm:inline">上一页</span>
                    </button>
                `;

                for (let i = 1; i <= totalPages; i++) {
                    if (i === currentPage) {
                        paginationHTML += `<span class="pagination-button px-4 py-2 bg-blue-600 text-white rounded-lg font-medium" aria-current="page">${i}</span>`;
                    } else {
                        paginationHTML += `
                            <button
                                onclick="window.roomManager.changeMyRoomsPage(${i})"
                                class="pagination-button px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
                                aria-label="Go to page ${i} of my rooms"
                            >
                                ${i}
                            </button>
                        `;
                    }
                }

                paginationHTML += `
                    <button
                        onclick="window.roomManager.changeMyRoomsPage(${currentPage + 1})"
                        class="pagination-button px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage === totalPages ? 'disabled' : ''}
                        aria-label="Next page for my rooms"
                    >
                        <span class="hidden sm:inline">下一页</span>
                        <i class="fas fa-chevron-right ml-1 sm:ml-2"></i>
                    </button>
                `;
                container.innerHTML = paginationHTML;
            }

            changeMyRoomsPage(newPage) {
                AppState.myRoomsCurrentPage = newPage;
                this.renderMyRooms();
            }

            createMyRoomRow(room) {
                const statusBadge = room.status === 'live'
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"><span class="w-2 h-2 bg-red-400 rounded-full mr-1 animate-pulse"></span>直播中</span>'
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">离线</span>';

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-[#1A1A1A]">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900 dark:text-white truncate max-w-xs" title="${room.name}">${room.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500 dark:text-gray-400">${room.createTime}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2 flex-wrap gap-2">
                                <button onclick="window.roomManager.copyShareLink('${room.id}', this)" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300" title="Copy share link">
                                    <i class="fas fa-share-alt mr-1"></i>
                                    分享链接
                                </button>
                                <button onclick="window.roomManager.showTransferHostModal('${room.id}', '${room.name.replace(/'/g, "\\'")}')" class="text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300" title="Transfer host">
                                    <i class="fas fa-exchange-alt mr-1"></i>
                                    转移所有权
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            async createRoom(roomName) {
                if (!roomName.trim()) {
                    this.showNotification('请输入房间名称', 'error');
                    return;
                }

                try {
                    // API spec for POST /chat/room request body is not defined. Assuming it takes { name: "roomName" }.
                    const responsePayload = await fetchAPI('/room/create', {
                        method: 'POST',
                        body: JSON.stringify({ name: roomName.trim() })
                    });

                    const newApiRoom = responsePayload.room;

                    const myRoomEntry = {
                        id: newApiRoom.share_link,
                        name: newApiRoom.name,
                        createTime: formatISODate(newApiRoom.created_at),
                        status: 'offline', // New rooms are offline by default
                        ownerName: AppState.currentUser.name
                    };
                    AppState.myRooms.unshift(myRoomEntry);

                    const allRoomEntry = {
                        id: newApiRoom.share_link,
                        name: newApiRoom.name,
                        creator: AppState.currentUser.name,
                        createTime: formatISODate(newApiRoom.created_at),
                        status: 'offline',
                        audienceCount: 0 // New rooms have 0 audience
                    };
                    AppState.allRooms.unshift(allRoomEntry);

                    AppState.myRoomsCurrentPage = 1;
                    AppState.allRoomsCurrentPage = 1;
                    this.renderMyRooms();
                    this.renderAllRooms();
                    this.showNotification('房间创建成功！', 'success');

                } catch (error) {
                    this.showNotification('创建房间失败', 'error');
                }
            }


            showTransferHostModal(roomId, roomName) {
                this.roomIdToTransfer = roomId;
                this.roomNameToTransfer = roomName;
                const modal = document.getElementById('transfer-host-modal');
                const roomNameInfoEl = document.getElementById('transfer-room-name-info');
                const newHostNameInput = document.getElementById('new-host-name-input');

                if (modal && roomNameInfoEl && newHostNameInput) {
                    roomNameInfoEl.textContent = `您正在转移房间 "${roomName}" 的所有权。`;
                    newHostNameInput.value = '';
                    modal.classList.remove('hidden');
                    newHostNameInput.focus();
                }
            }

            async _handleConfirmTransfer() {
                const newHostNameInput = document.getElementById('new-host-name-input');
                if (!newHostNameInput || !this.roomIdToTransfer) return;

                const newHostName = newHostNameInput.value.trim();
                if (newHostName) {
                    await this.transferHost(this.roomIdToTransfer, newHostName);
                    this.closeTransferHostModal();
                } else {
                    this.showNotification('请输入有效的主持人名称', 'error');
                    newHostNameInput.focus();
                }
            }

            closeTransferHostModal() {
                const modal = document.getElementById('transfer-host-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
                this.roomIdToTransfer = null;
                this.roomNameToTransfer = null;
            }


            async transferHost(roomId, newHostName) {
                //TODO: Backend API call to transfer ownership. API endpoint not specified.
                // Example: await fetchAPI(`/chat/room/${roomId}/transfer`, { method: 'POST', body: JSON.stringify({ newOwnerUsername: newHostName }) });
                this.showNotification(`转移房间所有权 (API 未实现): ${this.roomNameToTransfer} -> ${newHostName}`, 'info');

                // Frontend optimistic update (or update after successful API call)
                const myRoomIndex = AppState.myRooms.findIndex(r => r.id === roomId && r.ownerName === AppState.currentUser.name);
                const allRoom = AppState.allRooms.find(r => r.id === roomId);

                if (myRoomIndex !== -1) { // If it was in "My Rooms"
                    AppState.myRooms.splice(myRoomIndex, 1);
                }
                if (allRoom) {
                    allRoom.creator = newHostName; // Update creator in public list
                    allRoom.status = 'offline'; // Typically, ownership transfer might reset status
                    allRoom.audienceCount = 0;
                }

                this.renderMyRooms();
                this.renderAllRooms();
            }


            joinRoomByCode(shareCode) {
                if (!shareCode.trim()) {
                    this.showNotification('请输入分享代码', 'error');
                    return;
                }
                //TODO: Backend API call to validate shareCode and get room details/join. Endpoint not specified.
                // Example: const roomData = await fetchAPI(`/chat/join/${shareCode}`);
                // Then navigate or handle: window.location.href = roomData.actual_room_url;
                this.showNotification('正在加入房间 (API 未实现)...', 'info');
                // setTimeout(() => {
                //     window.location.href = `/${shareCode.trim()}`; // Placeholder navigation
                // }, 500);
            }


            copyShareLink(roomId, buttonElement) {
                const shareLink = `${window.location.origin}/${roomId}`;
                const originalButtonHTML = buttonElement.innerHTML;
                const copiedHTML = `<i class="fas fa-check mr-1"></i>已复制`;

                const showCopiedFeedback = () => {
                    buttonElement.innerHTML = copiedHTML;
                    buttonElement.disabled = true;
                    setTimeout(() => {
                        buttonElement.innerHTML = originalButtonHTML;
                        buttonElement.disabled = false;
                    }, 2000);
                };

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(shareLink).then(() => {
                        this.showNotification('链接已复制到剪贴板', 'success');
                        showCopiedFeedback();
                    }).catch((err) => {
                        this.fallbackCopyToClipboard(shareLink, showCopiedFeedback);
                    });
                } else {
                    this.fallbackCopyToClipboard(shareLink, showCopiedFeedback);
                }
            }

            fallbackCopyToClipboard(text, successCallback) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showNotification('链接已复制到剪贴板 (fallback)', 'success');
                        if (successCallback) successCallback();
                    } else {
                        this.showNotification('复制失败，请手动复制链接', 'error');
                    }
                } catch (err) {
                    this.showNotification('复制失败，请手动复制链接', 'error');
                }

                document.body.removeChild(textArea);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                const typeClasses = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500'
                };
                const iconClasses = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                notification.className = `fixed top-4 right-4 ${typeClasses[type] || typeClasses.info} text-white px-6 py-3 rounded-lg shadow-lg z-[100] transform translate-x-full transition-transform duration-300 ease-out`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${iconClasses[type] || iconClasses.info} mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;

                document.body.appendChild(notification);

                requestAnimationFrame(() => {
                    notification.style.transform = 'translateX(0)';
                });

                setTimeout(() => {
                    notification.style.transform = 'translateX(calc(100% + 1rem))';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            bindEvents() {
                const searchInput = document.getElementById('search-rooms');
                if (searchInput) {
                    searchInput.addEventListener('input', () => {
                        AppState.allRoomsCurrentPage = 1;
                        this.renderAllRooms();
                    });
                }

                const filterSelect = document.getElementById('filter-status');
                if (filterSelect) {
                    filterSelect.addEventListener('change', () => {
                        AppState.allRoomsCurrentPage = 1;
                        this.renderAllRooms();
                    });
                }

                const modal = document.getElementById('create-room-modal');
                const createBtn = document.getElementById('create-room-btn');
                const closeBtn = document.getElementById('close-modal');
                const cancelBtn = document.getElementById('cancel-create-room');
                const confirmBtn = document.getElementById('confirm-create-room');
                const roomNameInput = document.getElementById('room-name-input');

                const openModalAction = () => {
                    if (modal && roomNameInput) {
                        modal.classList.remove('hidden');
                        roomNameInput.value = '';
                        roomNameInput.focus();
                    }
                };

                if (createBtn) {
                    createBtn.addEventListener('click', openModalAction);
                }

                const closeModalAction = () => {
                    if (modal && roomNameInput) {
                        modal.classList.add('hidden');
                        roomNameInput.value = '';
                    }
                };

                if (closeBtn) {
                    closeBtn.addEventListener('click', closeModalAction);
                }

                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeModalAction);
                }

                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeModalAction();
                        }
                    });
                }


                if (confirmBtn && roomNameInput) {
                    confirmBtn.addEventListener('click', async () => {
                        const roomName = roomNameInput.value;
                        if (roomName.trim()) {
                            await this.createRoom(roomName);
                            closeModalAction();
                        } else {
                            this.showNotification('请输入房间名称', 'error');
                            roomNameInput.focus();
                        }
                    });
                }

                if (roomNameInput) {
                    roomNameInput.addEventListener('keypress', async (e) => {
                        if (e.key === 'Enter') {
                            const roomName = roomNameInput.value;
                            if (roomName.trim()) {
                                await this.createRoom(roomName);
                                closeModalAction();
                            } else {
                                this.showNotification('请输入房间名称', 'error');
                                roomNameInput.focus();
                            }
                        }
                    });
                }

                const joinModal = document.getElementById('join-room-modal');
                const joinBtn = document.getElementById('join-room-btn');
                const closeJoinBtn = document.getElementById('close-join-modal');
                const cancelJoinBtn = document.getElementById('cancel-join-room');
                const confirmJoinBtn = document.getElementById('confirm-join-room');
                const shareCodeInput = document.getElementById('share-code-input');

                const openJoinModalAction = () => {
                    if (joinModal && shareCodeInput) {
                        joinModal.classList.remove('hidden');
                        shareCodeInput.value = '';
                        shareCodeInput.focus();
                    }
                };

                if (joinBtn) {
                    joinBtn.addEventListener('click', openJoinModalAction);
                }

                const closeJoinModalAction = () => {
                    if (joinModal && shareCodeInput) {
                        joinModal.classList.add('hidden');
                        shareCodeInput.value = '';
                    }
                };

                if (closeJoinBtn) {
                    closeJoinBtn.addEventListener('click', closeJoinModalAction);
                }

                if (cancelJoinBtn) {
                    cancelJoinBtn.addEventListener('click', closeJoinModalAction);
                }

                if (joinModal) {
                    joinModal.addEventListener('click', (e) => {
                        if (e.target === joinModal) {
                            closeJoinModalAction();
                        }
                    });
                }

                if (confirmJoinBtn && shareCodeInput) {
                    confirmJoinBtn.addEventListener('click', () => {
                        const shareCode = shareCodeInput.value.trim();
                        if (shareCode) {
                            this.joinRoomByCode(shareCode);
                        } else {
                            this.showNotification('请输入分享代码', 'error');
                            shareCodeInput.focus();
                        }
                    });
                }

                if (shareCodeInput) {
                    shareCodeInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const shareCode = shareCodeInput.value.trim();
                            if (shareCode) {
                                this.joinRoomByCode(shareCode);
                            } else {
                                this.showNotification('请输入分享代码', 'error');
                                shareCodeInput.focus();
                            }
                        }
                    });
                }

                document.querySelectorAll('.create-room-trigger').forEach(trigger => {
                    trigger.addEventListener('click', openModalAction);
                });
            }

            bindTransferHostModalEvents() {
                const transferModal = document.getElementById('transfer-host-modal');
                const closeTransferBtn = document.getElementById('close-transfer-modal');
                const cancelTransferBtn = document.getElementById('cancel-transfer-host');
                const confirmTransferBtn = document.getElementById('confirm-transfer-host');
                const newHostNameInput = document.getElementById('new-host-name-input');

                if (closeTransferBtn) {
                    closeTransferBtn.addEventListener('click', () => this.closeTransferHostModal());
                }
                if (cancelTransferBtn) {
                    cancelTransferBtn.addEventListener('click', () => this.closeTransferHostModal());
                }
                if (transferModal) {
                    transferModal.addEventListener('click', (e) => {
                        if (e.target === transferModal) {
                            this.closeTransferHostModal();
                        }
                    });
                }
                if (confirmTransferBtn) {
                    confirmTransferBtn.addEventListener('click', async () => await this._handleConfirmTransfer());
                }
                if (newHostNameInput) {
                    newHostNameInput.addEventListener('keypress', async (e) => {
                        if (e.key === 'Enter') {
                            await this._handleConfirmTransfer();
                        }
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            window.themeManager = new ThemeManager(); // This will also fetch user profile
            window.roomManager = new RoomManager(); // This will fetch rooms data after user profile is available (implicitly via AppState.currentUser)
        });
    </script>
</body>

</html>